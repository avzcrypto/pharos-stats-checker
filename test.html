<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pharos Testnet Leaderboard - Top 100 Rankings</title>
    <meta name="description" content="Live Pharos testnet leaderboard with top 100 users and detailed activity breakdown by protocol.">
    <link rel="icon" type="image/webp" href="./logo.webp">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f2ed 0%, #e8eaf6 30%, #e3f2fd 60%, #bbdefb 100%);
            color: #1f2937;
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-size: 36px;
            font-weight: 900;
            color: #111827;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .header-left p {
            color: #6b7280;
            font-size: 16px;
            font-weight: 500;
        }

        .header-stats {
            display: flex;
            gap: 40px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 6px;
        }

        .stat-label {
            font-size: 13px;
            color: #6b7280;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Update Info */
        .update-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 24px;
            font-size: 14px;
            color: #1d4ed8;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .update-dot {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.1); }
        }

        /* Distribution Section */
        .distribution-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        }

        .distribution-title {
            font-size: 20px;
            font-weight: 800;
            color: #111827;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .level-bars {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .level-bar {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .level-label {
            min-width: 160px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: #666;
        }

        .bar-container {
            flex: 1;
            height: 32px;
            background: rgba(243, 244, 246, 0.8);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            backdrop-filter: blur(5px);
        }

        .bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .level-stats {
            min-width: 160px;
            text-align: right;
            font-size: 13px;
            color: #6b7280;
        }

        .level-count {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: #111827;
        }

        /* Level Colors */
        .level-1 { background: linear-gradient(90deg, #6b7280, #4b5563); }
        .level-2 { background: linear-gradient(90deg, #84cc16, #65a30d); }
        .level-3 { background: linear-gradient(90deg, #06b6d4, #0891b2); }
        .level-4 { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
        .level-5 { background: linear-gradient(90deg, #fbbf24, #f59e0b); }

        /* Main Table Section */
        .table-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
        }

        .table-header {
            background: rgba(249, 250, 251, 0.9);
            padding: 24px 32px;
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
        }

        .table-title {
            font-size: 20px;
            font-weight: 800;
            color: #111827;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        /* Table Headers */
        .leaderboard-table thead th {
            background: rgba(249, 250, 251, 0.95);
            padding: 16px 12px;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-right: 1px solid rgba(229, 231, 235, 0.5);
            border-bottom: 2px solid rgba(229, 231, 235, 0.8);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        .leaderboard-table thead th:last-child {
            border-right: none;
        }

        .header-main {
            border-bottom: 1px solid #d1d5db;
            padding: 10px;
        }

        .header-sub {
            padding: 10px;
            font-size: 10px;
            font-weight: 500;
        }

        /* Table Body */
        .leaderboard-table tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.7);
        }

        .leaderboard-table tbody tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.7);
        }

        .leaderboard-table tbody tr {
            border-bottom: 1px solid rgba(243, 244, 246, 0.5);
            transition: all 0.2s ease;
        }

        .leaderboard-table tbody tr:hover {
            background: rgba(241, 245, 249, 0.9) !important;
            transform: scale(1.01);
        }

        .leaderboard-table td {
            padding: 16px 12px;
            text-align: center;
            border-right: 1px solid rgba(243, 244, 246, 0.5);
            vertical-align: middle;
        }

        .leaderboard-table td:last-child {
            border-right: none;
        }

        /* Rank Column */
        .rank {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 16px;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .rank-1 { background: linear-gradient(145deg, #fbbf24, #f59e0b); color: #92400e; }
        .rank-2 { background: linear-gradient(145deg, #d1d5db, #9ca3af); color: #374151; }
        .rank-3 { background: linear-gradient(145deg, #f59e0b, #d97706); color: #92400e; }
        .rank-top10 { background: linear-gradient(145deg, #dbeafe, #bfdbfe); color: #1d4ed8; }
        .rank-default { background: linear-gradient(145deg, #f3f4f6, #e5e7eb); color: #6b7280; }

        /* User Column */
        .user-info {
            text-align: left;
            min-width: 140px;
        }

        .address {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: #1f2937;
            font-weight: 600;
        }

        /* Points & Level */
        .points-level {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 120px;
        }

        .points {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            font-size: 18px;
            color: #111827;
        }

        .level-badge {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        /* Activity Numbers */
        .activity-number {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .activity-zero {
            color: #9ca3af;
        }

        /* Loading & Error States */
        .loading {
            display: none;
            text-align: center;
            padding: 80px 20px;
        }

        .loading.show { display: block; }

        .loading-content {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            display: inline-block;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            font-weight: 600;
            color: #6b7280;
        }

        .error-state {
            background: rgba(254, 242, 242, 0.9);
            border: 1px solid rgba(254, 202, 202, 0.5);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            backdrop-filter: blur(20px);
        }

        .error-title {
            font-size: 20px;
            font-weight: 700;
            color: #dc2626;
            margin-bottom: 12px;
        }

        .error-message {
            color: #6b7280;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .retry-btn {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .retry-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.4);
        }

        /* Debug Info */
        .debug-info {
            background: rgba(17, 24, 39, 0.9);
            color: #e5e7eb;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            display: none;
            backdrop-filter: blur(20px);
        }

        .debug-info.show { display: block; }

        .debug-title {
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .header-content {
                flex-direction: column;
                gap: 24px;
                text-align: center;
            }
            
            .header-stats {
                gap: 32px;
            }
            
            .table-container {
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 24px;
            }
            
            .header-left h1 {
                font-size: 28px;
            }
            
            .header-stats {
                flex-direction: column;
                gap: 20px;
            }
            
            .level-bars {
                gap: 12px;
            }
            
            .level-label {
                min-width: 120px;
                font-size: 12px;
            }
            
            .level-stats {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1>üèÜ Pharos Leaderboard</h1>
                    <p>Top 100 users ranked by total points</p>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalChecks">0</div>
                        <div class="stat-label">Total Checks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="topScore">0</div>
                        <div class="stat-label">Top Score</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Info -->
        <div class="update-info" id="updateInfo" style="display: none;">
            <div class="update-dot"></div>
            <span id="updateText">Loading...</span>
        </div>

        <!-- Debug Info -->
        <div class="debug-info" id="debugInfo">
            <div class="debug-title">üîß Debug Information</div>
            <div id="debugContent">Initializing...</div>
        </div>

        <!-- User Distribution Section -->
        <div class="distribution-section" id="distributionSection" style="display: none;">
            <div class="distribution-title">
                üìä User Distribution by Level
            </div>
            
            <div class="level-bars" id="levelBars">
                <div class="level-bar" data-level="1">
                    <div class="level-label">
                        <div class="level-icon">1</div>
                        Lv.1 (0-1,000)
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill level-1" style="width: 0%"></div>
                    </div>
                    <div class="level-stats">
                        <span class="level-count">0</span> users (0.0%)
                    </div>
                </div>
                <div class="level-bar" data-level="2">
                    <div class="level-label">
                        <div class="level-icon">2</div>
                        Lv.2 (1,001-3,500)
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill level-2" style="width: 0%"></div>
                    </div>
                    <div class="level-stats">
                        <span class="level-count">0</span> users (0.0%)
                    </div>
                </div>
                <div class="level-bar" data-level="3">
                    <div class="level-label">
                        <div class="level-icon">3</div>
                        Lv.3 (3,501-6,000)
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill level-3" style="width: 0%"></div>
                    </div>
                    <div class="level-stats">
                        <span class="level-count">0</span> users (0.0%)
                    </div>
                </div>
                <div class="level-bar" data-level="4">
                    <div class="level-label">
                        <div class="level-icon">4</div>
                        Lv.4 (6,001-10,000)
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill level-4" style="width: 0%"></div>
                    </div>
                    <div class="level-stats">
                        <span class="level-count">0</span> users (0.0%)
                    </div>
                </div>
                <div class="level-bar" data-level="5">
                    <div class="level-label">
                        <div class="level-icon">5</div>
                        Lv.5 (10,001+)
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill level-5" style="width: 0%"></div>
                    </div>
                    <div class="level-stats">
                        <span class="level-count">0</span> users (0.0%)
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading" id="loading">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p class="loading-text">Loading leaderboard data...</p>
            </div>
        </div>

        <!-- Error State -->
        <div class="error-state" id="errorState" style="display: none;">
            <div class="error-title">‚ö†Ô∏è Connection Error</div>
            <div class="error-message" id="errorMessage">Unable to load leaderboard data. Please try again.</div>
            <button class="retry-btn" onclick="loadLeaderboard()">üîÑ Retry</button>
        </div>

        <!-- Main Table -->
        <div class="table-section" id="tableSection" style="display: none;">
            <div class="table-header">
                <div class="table-title">üëë Top 100 Users</div>
            </div>
            
            <div class="table-container">
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width: 80px;">Rank</th>
                            <th rowspan="2" style="width: 160px;">User</th>
                            <th rowspan="2" style="width: 140px;">Points & Level</th>
                            <th colspan="2" class="header-main">Send</th>
                            <th colspan="2" class="header-main">Zenith</th>
                            <th colspan="2" class="header-main">Faroswap</th>
                            <th colspan="2" class="header-main">NFT & Domains</th>
                            <th rowspan="2" style="width: 80px;">RWAfi</th>
                            <th rowspan="2" style="width: 80px;">Stake</th>
                            <th rowspan="2" style="width: 90px;">BTC Bridge</th>
                            <th rowspan="2" style="width: 90px;">CFD Trading</th>
                        </tr>
                        <tr>
                            <th class="header-sub" style="width: 70px;">Onchain</th>
                            <th class="header-sub" style="width: 80px;">Primuslabs</th>
                            <th class="header-sub" style="width: 70px;">Swaps</th>
                            <th class="header-sub" style="width: 60px;">LP</th>
                            <th class="header-sub" style="width: 70px;">Swaps</th>
                            <th class="header-sub" style="width: 60px;">LP</th>
                            <th class="header-sub" style="width: 70px;">Domains</th>
                            <th class="header-sub" style="width: 60px;">NFTs</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentPage = 1;
        let allUsers = [];
        let lastUpdated = null;
        let updateTimer = null;
        let isLoading = false;
        
        const USERS_PER_PAGE = 100; // Show all top 100
        const CACHE_DURATION = 60 * 60 * 1000; // 1 hour

        // Level structure matching backend
        const LEVEL_STRUCTURE = [
            { name: "Lv.1", min: 0, max: 1000, key: "level-1" },
            { name: "Lv.2", min: 1001, max: 3500, key: "level-2" },
            { name: "Lv.3", min: 3501, max: 6000, key: "level-3" },
            { name: "Lv.4", min: 6001, max: 10000, key: "level-4" },
            { name: "Lv.5", min: 10001, max: Infinity, key: "level-5" }
        ];

        // DOM elements
        const elements = {
            loading: document.getElementById('loading'),
            errorState: document.getElementById('errorState'),
            errorMessage: document.getElementById('errorMessage'),
            tableSection: document.getElementById('tableSection'),
            leaderboardBody: document.getElementById('leaderboardBody'),
            totalUsers: document.getElementById('totalUsers'),
            totalChecks: document.getElementById('totalChecks'),
            topScore: document.getElementById('topScore'),
            updateInfo: document.getElementById('updateInfo'),
            updateText: document.getElementById('updateText'),
            distributionSection: document.getElementById('distributionSection'),
            debugInfo: document.getElementById('debugInfo'),
            debugContent: document.getElementById('debugContent')
        };

        // Utility functions
        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        function formatAddress(address) {
            if (!address || typeof address !== 'string') return 'Invalid';
            return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
        }

        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            if (rank <= 10) return 'rank-top10';
            return 'rank-default';
        }

        // Debug logging
        function debugLog(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            console.log(logEntry, data || '');
            
            // Update debug panel
            const debugContent = document.getElementById('debugContent');
            if (debugContent) {
                const currentContent = debugContent.innerHTML;
                debugContent.innerHTML = `${logEntry}${data ? ': ' + JSON.stringify(data, null, 2) : ''}\n${currentContent}`;
            }
        }

        // Time formatting
        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / (1000 * 60));
            
            if (minutes < 1) return 'just now';
            if (minutes === 1) return '1 minute ago';
            if (minutes < 60) return `${minutes} minutes ago`;
            
            const hours = Math.floor(minutes / 60);
            if (hours === 1) return '1 hour ago';
            return `${hours} hours ago`;
        }

        function formatTimeUntilNext(timestamp) {
            const nextUpdate = timestamp + CACHE_DURATION;
            const now = Date.now();
            const diff = nextUpdate - now;
            
            if (diff <= 0) return 'updating soon';
            
            const minutes = Math.floor(diff / (1000 * 60));
            if (minutes < 1) return 'less than 1 minute';
            if (minutes === 1) return '1 minute';
            if (minutes < 60) return `${minutes} minutes`;
            
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            if (hours === 1) {
                return remainingMinutes > 0 ? `1 hour ${remainingMinutes} minutes` : '1 hour';
            }
            return remainingMinutes > 0 ? `${hours} hours ${remainingMinutes} minutes` : `${hours} hours`;
        }

        // Update time info
        function updateTimeInfo() {
            if (!lastUpdated) return;

            const timeAgo = formatTimeAgo(lastUpdated);
            const timeUntilNext = formatTimeUntilNext(lastUpdated);
            
            elements.updateText.textContent = `Last updated: ${timeAgo} ‚Ä¢ Next refresh in ${timeUntilNext}`;
            elements.updateInfo.style.display = 'flex';
        }

        function startUpdateTimer() {
            if (updateTimer) clearInterval(updateTimer);
            
            updateTimeInfo();
            updateTimer = setInterval(updateTimeInfo, 60 * 1000);
        }

        function stopUpdateTimer() {
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
            elements.updateInfo.style.display = 'none';
        }

        // Create table row
        function createTableRow(user, globalIndex) {
            const rank = globalIndex + 1;
            
            // Validate user data
            if (!user || typeof user !== 'object') {
                debugLog(`Invalid user data at index ${globalIndex}`, user);
                return '';
            }
            
            const address = user.address || 'Unknown';
            const totalPoints = parseInt(user.total_points) || 0;
            const currentLevel = parseInt(user.current_level) || 1;
            
            // Activity counts with validation
            const sendCount = parseInt(user.send_count) || 0;
            const primuslabsSend = parseInt(user.primuslabs_send) || 0;
            const swapCount = parseInt(user.swap_count) || 0;
            const lpCount = parseInt(user.lp_count) || 0;
            const faroswapSwaps = parseInt(user.faroswap_swaps) || 0;
            const faroswapLp = parseInt(user.faroswap_lp) || 0;
            const mintDomain = parseInt(user.mint_domain) || 0;
            const mintNft = parseInt(user.mint_nft) || 0;
            const aquaflux = parseInt(user.aquaflux) || 0;
            const autostaking = parseInt(user.autostaking) || 0;
            const fiammaBridge = parseInt(user.fiamma_bridge) || 0;
            const brokex = parseInt(user.brokex) || 0;
            
            return `
                <tr>
                    <td>
                        <div class="rank ${getRankClass(rank)}">${rank}</div>
                    </td>
                    <td>
                        <div class="user-info">
                            <div class="address">${formatAddress(address)}</div>
                        </div>
                    </td>
                    <td>
                        <div class="points-level">
                            <div class="points">${formatNumber(totalPoints)}</div>
                            <div class="level-badge">LVL ${currentLevel}</div>
                        </div>
                    </td>
                    <td><span class="activity-number ${sendCount === 0 ? 'activity-zero' : ''}">${sendCount}</span></td>
                    <td><span class="activity-number ${primuslabsSend === 0 ? 'activity-zero' : ''}">${primuslabsSend}</span></td>
                    <td><span class="activity-number ${swapCount === 0 ? 'activity-zero' : ''}">${swapCount}</span></td>
                    <td><span class="activity-number ${lpCount === 0 ? 'activity-zero' : ''}">${lpCount}</span></td>
                    <td><span class="activity-number ${faroswapSwaps === 0 ? 'activity-zero' : ''}">${faroswapSwaps}</span></td>
                    <td><span class="activity-number ${faroswapLp === 0 ? 'activity-zero' : ''}">${faroswapLp}</span></td>
                    <td><span class="activity-number ${mintDomain === 0 ? 'activity-zero' : ''}">${mintDomain}</span></td>
                    <td><span class="activity-number ${mintNft === 0 ? 'activity-zero' : ''}">${mintNft}</span></td>
                    <td><span class="activity-number ${aquaflux === 0 ? 'activity-zero' : ''}">${aquaflux}</span></td>
                    <td><span class="activity-number ${autostaking === 0 ? 'activity-zero' : ''}">${autostaking}</span></td>
                    <td><span class="activity-number ${fiammaBridge === 0 ? 'activity-zero' : ''}">${fiammaBridge}</span></td>
                    <td><span class="activity-number ${brokex === 0 ? 'activity-zero' : ''}">${brokex}</span></td>
                </tr>
            `;
        }

        // Render table
        function renderTable() {
            debugLog(`Rendering table with ${allUsers.length} users`);
            
            if (!allUsers || allUsers.length === 0) {
                elements.leaderboardBody.innerHTML = `
                    <tr>
                        <td colspan="15" style="text-align: center; padding: 40px; color: #6b7280;">
                            ‚ùå No leaderboard data available
                        </td>
                    </tr>
                `;
                return;
            }

            const rowsHtml = allUsers.map((user, index) => {
                return createTableRow(user, index);
            }).join('');

            elements.leaderboardBody.innerHTML = rowsHtml;
            debugLog(`Table rendered successfully with ${allUsers.length} rows`);
        }

        // Animation functions
        function animateValue(element, start, end, duration = 1500) {
            if (!element) return;
            
            const startTime = performance.now();
            const range = end - start;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const current = start + (range * progress);
                element.textContent = formatNumber(Math.floor(current));
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // Update statistics with animation
        function updateStatistics(data) {
            debugLog('Updating statistics', {
                totalUsers: data.total_users,
                totalChecks: data.total_checks,
                topScore: data.leaderboard?.[0]?.total_points
            });
            
            const totalUsers = parseInt(data.total_users) || 0;
            const totalChecks = parseInt(data.total_checks) || 0;
            const topScore = parseInt(data.leaderboard?.[0]?.total_points) || 0;
            
            animateValue(elements.totalUsers, 0, totalUsers);
            animateValue(elements.totalChecks, 0, totalChecks);
            animateValue(elements.topScore, 0, topScore);
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è updateLevelDistribution
        function updateLevelDistribution(levelDistributionData) {
            debugLog('Updating level distribution', levelDistributionData);
            
            if (!levelDistributionData || typeof levelDistributionData !== 'object') {
                debugLog('Invalid level distribution data');
                return;
            }

            const totalUsers = Object.values(levelDistributionData).reduce((sum, count) => sum + (parseInt(count) || 0), 0);
            
            if (totalUsers === 0) {
                debugLog('No users in level distribution');
                return;
            }

            // Find maximum count for bar width calculation
            const counts = Object.values(levelDistributionData).map(count => parseInt(count) || 0);
            const maxCount = Math.max(...counts);

            debugLog(`Total users: ${totalUsers}, Max count: ${maxCount}`);

            // Update each level bar
            LEVEL_STRUCTURE.forEach((level, index) => {
                const count = parseInt(levelDistributionData[level.key]) || 0;
                const percentage = ((count / totalUsers) * 100).toFixed(1);
                const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;

                debugLog(`Level ${level.name}: ${count} users (${percentage}%), bar width: ${barWidth}%`);

                // Find the corresponding DOM elements
                const levelBar = document.querySelector(`.level-bar[data-level="${index + 1}"]`);
                if (levelBar) {
                    const barFill = levelBar.querySelector('.bar-fill');
                    const countElement = levelBar.querySelector('.level-count');
                    const statsElement = levelBar.querySelector('.level-stats');

                    if (barFill && countElement && statsElement) {
                        // Update bar width with staggered animation
                        setTimeout(() => {
                            barFill.style.width = `${barWidth}%`;
                        }, index * 200);

                        // Update text
                        setTimeout(() => {
                            animateValue(countElement, 0, count, 1000);
                            statsElement.innerHTML = `<span class="level-count">${formatNumber(count)}</span> users (${percentage}%)`;
                        }, index * 200 + 500);
                    }
                } else {
                    debugLog(`Level bar not found for level ${index + 1}`);
                }
            });
        }

        // Show/hide states
        function showLoading() {
            debugLog('Showing loading state');
            elements.loading.classList.add('show');
            elements.errorState.style.display = 'none';
            elements.tableSection.style.display = 'none';
            elements.distributionSection.style.display = 'none';
            stopUpdateTimer();
        }

        function showError(message = 'Unknown error occurred') {
            debugLog('Showing error state', message);
            elements.loading.classList.remove('show');
            elements.errorState.style.display = 'block';
            elements.tableSection.style.display = 'none';
            elements.distributionSection.style.display = 'none';
            elements.errorMessage.textContent = message;
            stopUpdateTimer();
        }

        function showTable() {
            debugLog('Showing table state');
            elements.loading.classList.remove('show');
            elements.errorState.style.display = 'none';
            elements.tableSection.style.display = 'block';
            elements.distributionSection.style.display = 'block';
        }

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        async function loadLeaderboard() {
            if (isLoading) {
                debugLog('Already loading, skipping request');
                return;
            }
            
            isLoading = true;
            showLoading();
            debugLog('Starting leaderboard load');

            try {
                // Test API connectivity first
                debugLog('Testing API connectivity...');
                
                const healthResponse = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                debugLog(`Health check response: ${healthResponse.status}`);
                
                if (!healthResponse.ok) {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                debugLog('Health check data', healthData);
                
                // Now load actual leaderboard data
                debugLog('Fetching leaderboard data...');
                
                const response = await fetch('/api/admin/stats', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                debugLog(`Leaderboard API response status: ${response.status}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    debugLog('API Error Response', errorText);
                    throw new Error(`API returned ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                debugLog('Leaderboard data received', {
                    success: data.success,
                    totalUsers: data.total_users,
                    leaderboardLength: data.leaderboard?.length,
                    levelDistribution: data.level_distribution
                });
                
                if (!data.success) {
                    throw new Error(data.error || 'API returned success: false');
                }

                // Validate data structure
                if (!data.leaderboard || !Array.isArray(data.leaderboard)) {
                    debugLog('Invalid leaderboard data structure', data);
                    throw new Error('Invalid leaderboard data: missing or invalid leaderboard array');
                }

                allUsers = data.leaderboard;
                lastUpdated = Date.now();
                
                debugLog(`Successfully loaded ${allUsers.length} users`);
                
                // Update UI components
                updateStatistics(data);
                
                // Handle level distribution - check if it exists and is valid
                if (data.level_distribution && typeof data.level_distribution === 'object') {
                    updateLevelDistribution(data.level_distribution);
                } else {
                    debugLog('No valid level_distribution found, calculating from users');
                    // Calculate distribution from user data as fallback
                    const calculated = calculateLevelDistributionFromUsers(allUsers);
                    updateLevelDistribution(calculated);
                }
                
                renderTable();
                startUpdateTimer();
                showTable();

                debugLog(`‚úÖ Leaderboard loaded successfully: ${allUsers.length} users`);

            } catch (error) {
                debugLog('‚ùå Error loading leaderboard', error.message);
                console.error('Leaderboard load error:', error);
                showError(`Failed to load leaderboard: ${error.message}`);
            } finally {
                isLoading = false;
            }
        }

        // Fallback: Calculate level distribution from users array
        function calculateLevelDistributionFromUsers(users) {
            debugLog('Calculating level distribution from users array');
            
            const distribution = {
                'level-1': 0, 'level-2': 0, 'level-3': 0, 'level-4': 0, 'level-5': 0
            };
            
            users.forEach(user => {
                const points = parseInt(user.total_points) || 0;
                
                if (points <= 1000) {
                    distribution['level-1']++;
                } else if (points <= 3500) {
                    distribution['level-2']++;
                } else if (points <= 6000) {
                    distribution['level-3']++;
                } else if (points <= 10000) {
                    distribution['level-4']++;
                } else {
                    distribution['level-5']++;
                }
            });
            
            debugLog('Calculated distribution', distribution);
            return distribution;
        }

        // Enhanced error handling for fetch requests
        async function safeFetch(url, options = {}) {
            debugLog(`Making request to: ${url}`);
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                const response = await fetch(url, {
                    ...options,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response;
                
            } catch (error) {
                debugLog(`Fetch error for ${url}`, error.message);
                throw error;
            }
        }

        // Initialize with comprehensive error handling
        async function init() {
            debugLog('üöÄ Initializing Pharos Leaderboard...');
            
            // Show debug panel initially
            elements.debugInfo.classList.add('show');
            
            try {
                // Test if we're in the right environment
                debugLog('Environment check', {
                    location: window.location.href,
                    userAgent: navigator.userAgent.substring(0, 100)
                });
                
                await loadLeaderboard();
                
                debugLog('‚úÖ Leaderboard initialization completed');
                
                // Hide debug panel after successful load
                setTimeout(() => {
                    elements.debugInfo.classList.remove('show');
                }, 5000);
                
            } catch (error) {
                debugLog('‚ùå Initialization failed', error.message);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // Auto-refresh every 5 minutes
        function startAutoRefresh() {
            setInterval(() => {
                debugLog('Auto-refreshing leaderboard...');
                loadLeaderboard();
            }, 5 * 60 * 1000); // 5 minutes
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            stopUpdateTimer();
            debugLog('Page unloading, cleanup completed');
        });

        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                init();
                startAutoRefresh();
            });
        } else {
            init();
            startAutoRefresh();
        }

        // Global error handler
        window.addEventListener('error', (event) => {
            debugLog('Global error caught', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno
            });
        });

        // Add manual refresh button functionality
        window.manualRefresh = function() {
            debugLog('Manual refresh triggered');
            loadLeaderboard();
        };
    </script>
</body>
</html>
